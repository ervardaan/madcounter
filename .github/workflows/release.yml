# =============================================================================
# GitHub Actions Release Workflow
# =============================================================================
#
# WHAT THIS DOES:
#   When you push a git tag like "v1.1.1", this workflow automatically:
#     1. Checks out your source code on 4 different machines in parallel
#     2. Compiles MADCounter natively on each platform
#     3. Attaches all compiled binaries to a GitHub Release
#
# PLATFORMS COVERED:
#   - Linux x86_64   (Ubuntu, Debian, Fedora, any Intel/AMD Linux)
#   - Linux arm64    (Raspberry Pi 4/5, AWS Graviton, Oracle A1)
#   - macOS arm64    (Apple Silicon M1/M2/M3/M4, all Macs from 2021+)
#   - Windows x86_64 (Windows 10/11)
#
# NOTE ON macOS INTEL:
#   GitHub retired reliable macOS-13 Intel runners. Intel Mac users (pre-2021)
#   are covered by Homebrew, which compiles from source on their machine:
#     brew install ervardaan/tap/madcounter
#
# HOW TO TRIGGER A RELEASE:
#   git tag v1.2.0
#   git push origin v1.2.0
#   GitHub Actions compiles everything and creates a release automatically.
#
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # -----------------------------------------------------------------------
  # JOB: build
  # Runs on 4 machines in parallel, one per platform.
  # -----------------------------------------------------------------------
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 — Ubuntu, Debian, Fedora, CentOS, Alpine, etc.
          - os: ubuntu-latest
            artifact_name: madcounter-linux-x86_64
            binary: madcounter
            cc: gcc

          # Linux arm64 — Raspberry Pi 4/5, AWS Graviton, Oracle A1
          - os: ubuntu-24.04-arm
            artifact_name: madcounter-linux-arm64
            binary: madcounter
            cc: gcc

          # macOS Apple Silicon — all Macs from late 2020 onwards (M1/M2/M3/M4)
          - os: macos-14
            artifact_name: madcounter-macos-arm64
            binary: madcounter
            cc: gcc

          # Windows 10/11 x86_64 — uses MinGW64 (gcc for Windows)
          - os: windows-latest
            artifact_name: madcounter-windows-x86_64.exe
            binary: madcounter.exe
            cc: gcc

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Verify compiler
        run: ${{ matrix.cc }} --version

      - name: Compile MADCounter
        shell: bash
        run: ${{ matrix.cc }} -Wall -Werror -O2 -std=c99 -o ${{ matrix.binary }} MADCounter.c

      - name: Smoke test
        shell: bash
        run: |
          echo "the quick brown fox" > /tmp/mc_test.txt
          ./${{ matrix.binary }} -f /tmp/mc_test.txt -c -w
          rm /tmp/mc_test.txt

      - name: Rename binary for release
        shell: bash
        run: cp ${{ matrix.binary }} ${{ matrix.artifact_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}

  # -----------------------------------------------------------------------
  # JOB: release
  # Runs after all 4 build jobs succeed.
  # Downloads the compiled binaries and attaches them to a GitHub Release.
  # -----------------------------------------------------------------------
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List artifacts
        run: ls -la artifacts/*/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: MADCounter ${{ github.ref_name }}
          body: |
            ## MADCounter ${{ github.ref_name }}

            A text analysis utility for character, word, and line statistics.

            ---

            ### Install

            **macOS (Homebrew — all Macs including Intel):**
            ```bash
            brew install ervardaan/tap/madcounter
            ```

            **Linux / macOS (one-line curl installer):**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/ervardaan/madcounter/main/scripts/install-binary.sh | bash
            ```

            **Windows (Scoop):**
            ```powershell
            scoop bucket add ervardaan https://github.com/ervardaan/scoop-bucket
            scoop install madcounter
            ```

            **Arch Linux (AUR):**
            ```bash
            yay -S madcounter
            ```

            **Ubuntu / Debian (PPA):**
            ```bash
            sudo add-apt-repository ppa:ervardaan/madcounter
            sudo apt update && sudo apt install madcounter
            ```

            ---

            ### Manual download

            | Platform | File |
            |----------|------|
            | Linux x86_64 (Intel/AMD desktops, servers) | `madcounter-linux-x86_64` |
            | Linux arm64 (Raspberry Pi 4/5, AWS Graviton) | `madcounter-linux-arm64` |
            | macOS Apple Silicon M1/M2/M3/M4 | `madcounter-macos-arm64` |
            | Windows 10/11 | `madcounter-windows-x86_64.exe` |

            After manual download on Linux/macOS:
            ```bash
            chmod +x madcounter-linux-x86_64
            sudo mv madcounter-linux-x86_64 /usr/local/bin/madcounter
            ```

            After manual download on Windows: move the `.exe` into any folder
            in your `%PATH%`, for example `C:\Windows\System32\`.

            ---

            ### Usage
            ```
            madcounter -f <file> -c       # character analysis
            madcounter -f <file> -w       # word analysis
            madcounter -f <file> -l       # line analysis
            madcounter -f <file> -Lw -Ll  # longest word and line
            madcounter -B <batch.txt>     # batch mode
            man madcounter                # full documentation (Linux/macOS)
            ```
          files: |
            artifacts/madcounter-linux-x86_64/madcounter-linux-x86_64
            artifacts/madcounter-linux-arm64/madcounter-linux-arm64
            artifacts/madcounter-macos-arm64/madcounter-macos-arm64
            artifacts/madcounter-windows-x86_64.exe/madcounter-windows-x86_64.exe
          draft: false
          prerelease: false
