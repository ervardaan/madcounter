# =============================================================================
# GitHub Actions Release Workflow
# =============================================================================
#
# WHAT THIS DOES:
#   When you push a git tag like "v1.0.0", this workflow automatically:
#     1. Checks out your source code on 5 different machines
#     2. Compiles MADCounter natively on each platform
#     3. Uploads all compiled binaries to a GitHub Release page
#
# PLATFORMS COVERED:
#   - Linux x86_64   (standard servers, Intel/AMD desktops)
#   - Linux arm64    (Raspberry Pi 4/5, AWS Graviton, Oracle A1)
#   - macOS x86_64   (Intel Macs, pre-2021)
#   - macOS arm64    (Apple Silicon M1/M2/M3/M4, 2021+)
#   - Windows x86_64 (Windows 10/11, Intel/AMD)
#
# HOW TO TRIGGER A RELEASE:
#   git tag v1.0.0
#   git push origin v1.0.0
#   GitHub Actions compiles everything and creates a release automatically.
#
# =============================================================================

name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # -----------------------------------------------------------------------
  # JOB: build
  # Runs on 5 machines in parallel, one per platform.
  # -----------------------------------------------------------------------
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          # ------------------------------------------------------------------
          # Linux x86_64
          # Standard 64-bit Intel/AMD. Covers Ubuntu, Debian, Fedora, etc.
          # ------------------------------------------------------------------
          - os: ubuntu-latest
            artifact_name: madcounter-linux-x86_64
            binary: madcounter
            cc: gcc

          # ------------------------------------------------------------------
          # Linux ARM64
          # Raspberry Pi 4/5, AWS Graviton, Oracle A1 free tier, etc.
          # GitHub provides native ARM64 Linux runners for public repos.
          # ------------------------------------------------------------------
          - os: ubuntu-24.04-arm
            artifact_name: madcounter-linux-arm64
            binary: madcounter
            cc: gcc

          # ------------------------------------------------------------------
          # macOS Intel (x86_64)
          # Macs released before late 2020.
          # ------------------------------------------------------------------
          - os: macos-13
            artifact_name: madcounter-macos-x86_64
            binary: madcounter
            cc: gcc

          # ------------------------------------------------------------------
          # macOS Apple Silicon (arm64)
          # M1/M2/M3/M4 Macs released from late 2020 onwards.
          # ------------------------------------------------------------------
          - os: macos-14
            artifact_name: madcounter-macos-arm64
            binary: madcounter
            cc: gcc

          # ------------------------------------------------------------------
          # Windows x86_64
          # Windows 10 and 11, Intel/AMD 64-bit.
          # Uses MinGW64 (gcc port for Windows), pre-installed on the runner.
          # Output binary is an .exe file.
          # ------------------------------------------------------------------
          - os: windows-latest
            artifact_name: madcounter-windows-x86_64.exe
            binary: madcounter.exe
            cc: gcc

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      # Verify the compiler is available and print its version
      - name: Verify compiler
        run: ${{ matrix.cc }} --version

      # Compile the binary. Use bash shell on all platforms (Git Bash on
      # Windows) so the same command works everywhere.
      - name: Compile MADCounter
        shell: bash
        run: ${{ matrix.cc }} -Wall -Werror -O2 -std=c99 -o ${{ matrix.binary }} MADCounter.c

      # Quick smoke test: verify the binary runs and produces correct output.
      # Uses bash on all platforms (Git Bash on Windows supports /tmp).
      - name: Smoke test
        shell: bash
        run: |
          echo "the quick brown fox" > /tmp/mc_test.txt
          ./${{ matrix.binary }} -f /tmp/mc_test.txt -c -w
          rm /tmp/mc_test.txt

      # Rename the binary to include the platform suffix before uploading,
      # so all 5 binaries can coexist in the same release.
      - name: Rename binary for release
        shell: bash
        run: cp ${{ matrix.binary }} ${{ matrix.artifact_name }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}

  # -----------------------------------------------------------------------
  # JOB: release
  # Runs after ALL 5 build jobs complete successfully.
  # Downloads all binaries and attaches them to a GitHub Release.
  # -----------------------------------------------------------------------
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List artifacts
        run: ls -la artifacts/*/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: MADCounter ${{ github.ref_name }}
          body: |
            ## MADCounter ${{ github.ref_name }}

            A text analysis utility for character, word, and line statistics.

            ---

            ### Install

            **macOS (Homebrew):**
            ```bash
            brew install ervardaan/tap/madcounter
            ```

            **Linux / macOS (one-liner):**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/ervardaan/madcounter/main/scripts/install-binary.sh | bash
            ```

            **Windows (Scoop):**
            ```powershell
            scoop bucket add ervardaan https://github.com/ervardaan/scoop-bucket
            scoop install madcounter
            ```

            **Arch Linux:**
            ```bash
            yay -S madcounter
            ```

            **Ubuntu/Debian (via PPA):**
            ```bash
            sudo add-apt-repository ppa:ervardaan/madcounter
            sudo apt update && sudo apt install madcounter
            ```

            ---

            ### Manual download

            | Platform | File |
            |----------|------|
            | Linux x86_64 (Intel/AMD) | `madcounter-linux-x86_64` |
            | Linux arm64 (Raspberry Pi, AWS Graviton) | `madcounter-linux-arm64` |
            | macOS Intel (pre-2021 Macs) | `madcounter-macos-x86_64` |
            | macOS Apple Silicon M1/M2/M3/M4 | `madcounter-macos-arm64` |
            | Windows 10/11 | `madcounter-windows-x86_64.exe` |

            After manual download on Linux/macOS:
            ```bash
            chmod +x madcounter-linux-x86_64
            sudo mv madcounter-linux-x86_64 /usr/local/bin/madcounter
            ```

            After manual download on Windows â€” move the `.exe` to any folder in
            your `%PATH%`, for example `C:\Windows\System32\`.

            ---

            ### Usage
            ```
            madcounter -f <file> -c       # character analysis
            madcounter -f <file> -w       # word analysis
            madcounter -f <file> -l       # line analysis
            madcounter -f <file> -Lw -Ll  # longest word and line
            madcounter -B <batch.txt>     # batch mode
            man madcounter                # full documentation (Linux/macOS)
            ```
          files: |
            artifacts/madcounter-linux-x86_64/madcounter-linux-x86_64
            artifacts/madcounter-linux-arm64/madcounter-linux-arm64
            artifacts/madcounter-macos-x86_64/madcounter-macos-x86_64
            artifacts/madcounter-macos-arm64/madcounter-macos-arm64
            artifacts/madcounter-windows-x86_64.exe/madcounter-windows-x86_64.exe
          draft: false
          prerelease: false
