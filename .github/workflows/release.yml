# =============================================================================
# GitHub Actions Release Workflow
# =============================================================================
#
# WHAT THIS DOES:
#   When you push a git tag like "v1.0.0", this workflow automatically:
#     1. Checks out your source code on multiple machines (Linux, macOS)
#     2. Compiles MADCounter on each platform natively
#     3. Uploads all compiled binaries to a GitHub Release page
#
# WHY THIS MATTERS FOR WORLDWIDE DISTRIBUTION:
#   - Users on Linux download the Linux binary
#   - Users on macOS download the macOS binary
#   - Nobody needs gcc or make — they just download and run
#   - The Homebrew formula and curl installer both rely on these artifacts
#
# HOW TO TRIGGER A RELEASE:
#   git tag v1.0.0
#   git push origin v1.0.0
#   → GitHub Actions compiles everything and creates a release automatically
#
# =============================================================================

name: Release

# -----------------------------------------------------------------------
# TRIGGER: Only runs when you push a tag starting with "v" (e.g. v1.0.0)
# -----------------------------------------------------------------------
on:
  push:
    tags:
      - 'v*'

jobs:
  # -----------------------------------------------------------------------
  # JOB: build
  # Runs on three different machines in parallel:
  #   1. ubuntu-latest  → produces: madcounter-linux-x86_64
  #   2. macos-13       → produces: madcounter-macos-x86_64  (Intel Mac)
  #   3. macos-14       → produces: madcounter-macos-arm64   (Apple Silicon)
  # -----------------------------------------------------------------------
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          # Linux x86_64 (standard cloud servers, most Linux desktops)
          - os: ubuntu-latest
            artifact_name: madcounter-linux-x86_64
            cc: gcc

          # macOS Intel (Macs before 2021)
          - os: macos-13
            artifact_name: madcounter-macos-x86_64
            cc: gcc

          # macOS Apple Silicon (Macs from 2021+, M1/M2/M3/M4)
          - os: macos-14
            artifact_name: madcounter-macos-arm64
            cc: gcc

    steps:
      # Step 1: Get your source code onto the GitHub machine
      - name: Checkout source code
        uses: actions/checkout@v4

      # Step 2: On macOS, gcc is an alias for Apple Clang; make sure it works
      - name: Verify compiler
        run: ${{ matrix.cc }} --version

      # Step 3: Compile the binary
      # -Wall     = all warnings
      # -Werror   = warnings are errors (same as your Makefile)
      # -O2       = optimize for speed
      # -std=c99  = C99 standard
      - name: Compile MADCounter
        run: ${{ matrix.cc }} -Wall -Werror -O2 -std=c99 -o madcounter MADCounter.c

      # Step 4: Quick smoke test — make sure the compiled binary runs
      - name: Smoke test
        run: |
          echo "the quick brown fox" > /tmp/test.txt
          ./madcounter -f /tmp/test.txt -c -w
          rm /tmp/test.txt

      # Step 5: Rename binary to include platform name
      # (all three binaries would be named "madcounter" without this,
      #  which would cause conflicts when uploading to the release)
      - name: Rename binary for release
        run: cp madcounter ${{ matrix.artifact_name }}

      # Step 6: Upload as a build artifact (passed to the release job below)
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}

  # -----------------------------------------------------------------------
  # JOB: release
  # Runs after ALL build jobs complete successfully.
  # Downloads all compiled binaries and attaches them to a GitHub Release.
  # -----------------------------------------------------------------------
  release:
    name: Create GitHub Release
    needs: build          # Wait for all builds to finish
    runs-on: ubuntu-latest

    # Required permission to create releases
    permissions:
      contents: write

    steps:
      # Download all three compiled binaries from the build job
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/        # Downloads into artifacts/<artifact_name>/

      # List what we downloaded (useful for debugging)
      - name: List artifacts
        run: ls -la artifacts/*/

      # Create the GitHub Release and attach all binaries
      # The release title is the tag name (e.g. "v1.0.0")
      # The body contains installation instructions for each platform
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: MADCounter ${{ github.ref_name }}
          body: |
            ## MADCounter ${{ github.ref_name }}

            A text analysis utility for character, word, and line statistics.

            ### Installation

            **macOS (Homebrew — recommended):**
            ```bash
            brew install ervardaan/tap/madcounter
            ```

            **Linux / macOS (curl installer):**
            ```bash
            curl -fsSL https://raw.githubusercontent.com/ervardaan/madcounter/main/scripts/install-binary.sh | bash
            ```

            **Manual download:**

            | Platform | Download |
            |----------|----------|
            | Linux x86_64 | [madcounter-linux-x86_64](madcounter-linux-x86_64) |
            | macOS Intel (x86_64) | [madcounter-macos-x86_64](madcounter-macos-x86_64) |
            | macOS Apple Silicon (arm64) | [madcounter-macos-arm64](madcounter-macos-arm64) |

            **After manual download:**
            ```bash
            chmod +x madcounter-*
            sudo mv madcounter-linux-x86_64 /usr/local/bin/madcounter   # Linux
            # or
            sudo mv madcounter-macos-arm64 /usr/local/bin/madcounter    # macOS M1+
            ```

            ### Usage
            ```
            madcounter -f <file> -c          # Character analysis
            madcounter -f <file> -w          # Word analysis
            madcounter -f <file> -l          # Line analysis
            madcounter -f <file> -Lw -Ll     # Longest word and line
            madcounter -B <batch.txt>        # Batch mode
            man madcounter                   # Full documentation
            ```
          files: |
            artifacts/madcounter-linux-x86_64/madcounter-linux-x86_64
            artifacts/madcounter-macos-x86_64/madcounter-macos-x86_64
            artifacts/madcounter-macos-arm64/madcounter-macos-arm64
          draft: false
          prerelease: false
